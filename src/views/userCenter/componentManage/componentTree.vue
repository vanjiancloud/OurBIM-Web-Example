<!-- ÊûÑ‰ª∂Ê†ë -->
<template>
    <Drawer ref="Drawer" title="Ê®°ÂûãÊµèËßàÂô®" direction="ltr" @onClose="close()">
        <template v-slot="{ drawer }">
            <Tab v-model="tabValue" :data="tabList" @onTab="onTab" />
            <div class="search">
                <el-input v-model="search" size="mini" placeholder="ËØ∑ËæìÂÖ•ÊÇ®Ë¶ÅÊêúÁ¥¢ÁöÑÂÜÖÂÆπ" prefix-icon="el-icon-search"
                    @change="searchContent()" @keydown.native.stop>
                </el-input>
            </div>
            <!-- Ê†ë -->
            <el-tree v-if="drawer && tabValue===0" class="set-tree" ref="tree" empty-text="ÊöÇÊó†Êï∞ÊçÆ" :props="props" :expand-on-click-node="false" :load="loadNode" @check="isShowCom" :filter-node-method="filterNode"
                :show-checkbox="true" highlight-current node-key="uuid" lazy>
                <span class="custom-tree-node" :class="{'tree-select': activeTree && node.data.uuid === activeTree.uuid}" slot-scope="{node,data}" @click="handleTree(node)">
                    <span class="label-span">{{ node.label }}</span>
                    <!-- Âà†Èô§ÊåâÈíÆ -->
                    <img src="@/assets/images/tag/6.png" @click.stop="deleteCom(node)" class="delect-com-icon" v-if="data.typeId === 'comp'" />
                    <!-- ÂºÄÈîÅÂíåÈó≠ÈîÅ -->
                    <span v-if="node.level === 1 && (appType === '3' || appType === '0') && !node.data.typeId">
                        <i class="iconfont" :class="data.lockCheck?'icon-24gl-unlock4':'icon-24gl-lock2'" @click.stop="toggleLock(data)"></i>
                    </span>
                    <!-- ÊòæÁ§∫Áä∂ÊÄÅ -->
                    <span>
                        <!-- <svg-icon class="icon" icon-class="freeze1" @click.stop="freezeCom(node)"/> -->
                        <i class="iconfont" :class="node.checked?'icon-yincang1':'icon-xianshi2'"></i>
                    </span>
                </span>
            </el-tree>

            <!-- ÊûÑ‰ª∂Êìç‰ΩúÂõæÊ†á -->
            <OperatingTools ref="OperatingTools" v-if="drawer && hasLock()" :data="data"/>

            <GisTree v-if="drawer && tabValue===1" :data="data"/>
        </template>
    </Drawer>
</template>

<script>
import Tab from "@/components/Tab/index.vue";
import { doAction, setGizmoMode } from "@/api/userCenter/index";
import { getComponents, lockAfterInfo, lockControl, freezeCom, deleteCustomCom, focusComponent, controlComShowOrHide, getModelLocation } from "@/api/userCenter/componentManage.js";
import Drawer from "@/components/Drawer/index.vue";
import OperatingTools from "@/components/OperatingTools";
import { EventBus } from '@/utils/bus.js'
import GisTree from './gisTree.vue'
export default {
    components: { Drawer, OperatingTools, Tab, GisTree },
    props: {
        data: {
            type: Object,
            default:()=> {}
        },
        // ÊûÑ‰ª∂Êï∞ÊçÆ
        memberInfo: {
            type: Array,
            require: false,
            default: ()=> []
        }
    },
    data() {
        return {
            tabValue: 0,
            tabList: [
                {
                    name: "BIMÊ®°Âûã",
                },
                {
                    hidden: !this.data.isGis,
                    name: "GISÊï∞ÊçÆÊúçÂä°",
                },
            ],
            appType: null,
            search: '',
            treeParentData: [],//tree‰∏ÄÁ∫ßÊï∞ÊçÆ
            props: {
                label: "name",
                isLeaf: (e) => {//ÊåáÂÆöÊòØÂê¶‰∏∫Âè∂Â≠êÁªìÁÇπ,Âè∂Â≠êÁªìÁÇπÂç≥‰∏∫ÊúÄÂêé‰∏Ä‰∏™ÁªìÁÇπ
                    if (e.haveChild === "1") {
                        return false;
                    }
                    if (e.haveChild === "0") {
                        return true;
                    }
                },
            },
            activeTree: null,//ÈÄâ‰∏≠Áä∂ÊÄÅ
        };
    },
    watch: {},
    computed: {},
    created() {
        this.appType = this.$route.query.appType
    },
    mounted() {
        // if(this.data.isGis){
        //     this.tabList[1].hidden = true
        // }
    },
    methods: {
        show() {
            this.$refs.Drawer.show()
        },
        close() {
            this.$refs.Drawer.hide()
            EventBus.$emit('eventTool', 'browser')
        },
        onTab(e){
            this.tabValue = e.index
        },
        // ÊêúÁ¥¢
        searchContent() {
            this.$refs.tree.filter(this.search);
        },
        // ÊêúÁ¥¢ËøáÊª§
        filterNode(value, data) {
            if (!value) return true;
            const reamVal = data.name.indexOf(value) !== -1;
            return reamVal;
        },
        //ÈÅçÂéÜÊòØÂê¶ÊúâÈîÅÊâìÂºÄ‰∫Ü
        hasLock(){
            let index = this.treeParentData.findIndex(e=>{return e.lockCheck})
            return index > -1
        },
        // Ëé∑ÂèñÊ†ëÂàóË°®
        async getList(node) {
            let params = {
                appliId: node?.data?.projectId||this.data.appId,
                uuid: node&&node.key,
                pageNo: 1,
                pageSize: 20,
            };
            let list = await getComponents(params).then((res) => {
                return res.data || [];
            });

            return list;
        },
        // Âä†ËΩΩÂ≠êÊ†ëÊï∞ÊçÆÁöÑÊñπÊ≥ïÔºå‰ªÖÂΩì lazy Â±ûÊÄß‰∏∫true Êó∂ÁîüÊïà
        loadNode(node, resolve) {
            this.getList(node).then((res) => {
                if(node.level === 0){
                    this.treeParentData = res
                }
                res.length&&res.forEach((item) => {
                    // ÁÇπÂáªÈîÅüîí
                    this.$set(item,'lockCheck',false)
                    //ÈÄâ‰∏≠ËÅöÁÑ¶
                    this.$set(item,'check',false)
                });
                return resolve(res);
            }).catch(()=>{
                return resolve([]);
            });
        },
        // ÁÇπÂáªËÅöÁÑ¶Êìç‰Ωú
        handleTree(e) {
            e.data.check = !e.data.check
            // ÂàáÊç¢‰∏çÂêåÊûÑ‰ª∂
            if(this.activeTree && (e.data.uuid !== this.activeTree.uuid)){
                e.data.check = true
            }
            this.activeTree = e.data.check ? e.data : null
            // Êñ∞Â¢û‰ø©‰∏™Â±ûÊÄßÊîæÂú®ÊúÄÂâçÈù¢
            if(e.data?.dynamicData?.length){
                e.data.dynamicData = [{name:'ÊûÑ‰ª∂ID',value:e.data.revitCode},{name:'ÊûÑ‰ª∂ÂêçÁß∞',value:e.data.name}].concat(e.data.dynamicData)
            }
            let memberInfo = e.data.dynamicData || []
            this.$emit('update:memberInfo',memberInfo)
            if(e.data.typeId === 'comp'){
                // Ëá™ÂÆö‰πâÊûÑ‰ª∂
                this.focusCustomComponent({comId: e.data.uuid, flag: e.data.check})
            }else{
                // ÈÄâ‰∏≠ÊûÑ‰ª∂ÊàñËÄÖÂèñÊ∂àÈÄâ‰∏≠
                let data = {
                    projectId: e.data.projectId || e.data.compData?.projectId,
                    mn: e.data.uuid,
                    action: e.data.check ? 'selectComponent' : 'cancelSelectComponent'
                }
                this.updateEdit(data);
            }
        },
        // Ëá™ÂÆö‰πâÊûÑ‰ª∂ËÅöÁÑ¶
        focusCustomComponent({ comId, flag }){
            let params = {
                taskId: this.data.taskId,
                comId,
                flag
            }
            focusComponent(params).then((res) => {
                this.$message.success(res.message)
            })
        },
        // Âà†Èô§ÊûÑ‰ª∂
        deleteCom(node) {
            const { name, uuid } = node.data;
            this.$confirm(`Ê≠§Êìç‰ΩúÂà†Èô§Ê≠§„Äê${name}„ÄëÊûÑ‰ª∂, ÊòØÂê¶ÁªßÁª≠?`, "ÊèêÁ§∫", {
                confirmButtonText: "Á°ÆÂÆö",
                cancelButtonText: "ÂèñÊ∂à",
                type: "warning",
            }).then(() => {
                deleteCustomCom({
                    taskId: this.data.taskId,
                    comId: uuid,
                }).then((res) => {
                    this.$message.success(res.message)
                    this.updateTree(node.data.uuid);
                });
            }).catch(() => {});
        },
        // Âà†Èô§ÊûÑ‰ª∂ÂêéÊõ¥Êñ∞treeÊï∞ÊçÆ
        updateTree(uuid) {
            if(!this.$refs.tree) return
            // Ëé∑ÂèñËá™ÂÆö‰πâÊûÑ‰ª∂Áà∂Á∫ßnode
            const nodeParent = this.$refs.tree.getNode(uuid).parent;
            this.$refs.tree.remove(uuid);
            if (!nodeParent.childNodes.length) {
                this.$refs.tree.remove(nodeParent.data.uuid);
            }
        },
        // ÁÇπÂáªÈîÅ
        toggleLock(data = { lockCheck: false }){
            if(data.uuid){
                data.lockCheck = !data.lockCheck
            }
            this.$refs.tree && this.$refs.tree.root.childNodes.forEach(e=>{
                if(e.data.uuid !== data.uuid){
                    e.data.lockCheck = false
                }
            })
            const params = {
                taskId: this.data.taskId,
                flag: data.lockCheck ? "on" : "off"
            }
            lockControl(params).then((res) => {
                if(params.flag === 'on'){
                    this.setGizmoMode('translate')
                    const infoParam = {
                        taskId: this.data.taskId,
                        actorOrAppId: data.projectId
                    }
                    lockAfterInfo(infoParam).then((res) => {
                        this.$refs.OperatingTools.checkOprate({gizmoMode:'translate'})
                    });
                    // Âú®Âá†‰Ωï‰ø°ÊÅØÊòæÁ§∫Êï¥‰ΩìÊ®°ÂûãÂùêÊ†á‰ø°ÊÅØ
                    getModelLocation({appId: data.projectId}).then(res=>{
                        let resData = res.data[0]
                        this.$parent.selectPark = { 
                            id: '1', 
                            mN: resData.appId,
                            model: true,
                            object: {},
                            rsInfo: [
                                { key: 'name', name: 'ÂêçÁß∞', value: data.name },
                                { key: 'location', name: '‰ΩçÁΩÆ', value: resData.location },
                                { key: 'rotation', name: 'ÊóãËΩ¨', value: resData.rotation },
                                { key: 'scale', name: 'Áº©Êîæ', value: resData.scale },
                            ]
                        }
                        this.$parent.memberInfo = []
                    })
                }else{
                    this.$parent.selectPark = { id: '1' }
                }
                setTimeout(()=>{
                    this.hasLock()
                },200)
            });        
        },
        // ÊâìÂºÄÁº©ÊîæÔºåÊóãËΩ¨ÔºåÁßªÂä®
        setGizmoMode(mode){
            let params ={
                taskId: this.data.taskId,
                mode
            }
            setGizmoMode(params).then(()=>{
                this.$message.success('ÂàáÊç¢ÁºñËæëÊ®°Âºè')
            })
        },
        // ÁÇπÂáªÊòæÁ§∫ÊàñÈöêËóèÊûÑ‰ª∂
        isShowCom(data, e){
            if(data.typeId === "comp"){
                // Ëá™ÂÆö‰πâÊûÑ‰ª∂
                let params = {
                    comId: data.uuid,
                    taskId: this.data.taskId,
                    lableVisibility: !e.checkedKeys.includes(data.uuid)
                }
                controlComShowOrHide(params)
            }else{
                // Ê®°ÂûãÊûÑ‰ª∂
                let params = {
                    mn: data.uuid,
                    projectId: data.projectId || data.compData?.projectId,
                    action: !e.checkedKeys.includes(data.uuid) ? 'showComponents' : 'hideComponents'
                }
                this.updateEdit(params)
            }
        },
        // Ê∑ªÂä†ÊûÑ‰ª∂ÂêéÊõ¥Êñ∞ÂàóË°®
        updateComTreeAfterAddComs() {
            if (this.appType === "3") {
                // ÂêàÊ®°
                this.handleMultModle();
            } else {
                this.getList({key:"vanjian"}).then((res) => {
                    this.$refs.tree && this.$refs.tree.updateKeyChildren("vanjian", res);
                })
            }
        },
        // Êü•ÁúãÊúâÊ≤°ÊúâÂêàÊ®°ÁöÑËá™ÂÆö‰πâÊûÑ‰ª∂
        // ÂêàÊ®°ÂøÖÁÑ∂Êúâ uuid vanjian1
        handleMultModle() {
            if(!this.$refs.tree) return
            const godNodeList = this.$refs.tree.getNode("vanjian1").parent.childNodes;
            const mult = godNodeList.find((item) => {
                return item.data.typeId === "comp";
            });

            let uuid = mult ? mult.data.uuid : null;
            // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÊûÑ‰ª∂Ôºå‰øùÂ≠òÊúÄÂêé‰∏Ä‰∏™ËäÇÁÇπÔºåÁî®Êù•insertAfterËäÇÁÇπ
            if (!uuid) {
                this.getList().then((res) => {
                    let customMess = res[res.length - 1];
                    this.$refs.tree.insertAfter(customMess,godNodeList[godNodeList.length-1].data.uuid);
                })
            }else{
                // Â¶ÇÊûúÊúâ‰∫ÜËá™ÂÆö‰πâÊûÑ‰ª∂ÂàóË°®
                this.getList({key:uuid}).then((res) => {
                    this.$refs.tree && this.$refs.tree.updateKeyChildren(uuid, res);
                })
            }
        },
        // ÂÜªÁªì‰∏éËß£ÂÜª
        freezeCom(node){
            let params = {
                taskId:this.data.taskId,
                isFreeze:'',
                isAll: node.level===1 ? true : false, //ÊòØÂê¶ÂÜªÁªìÊâÄÊúâ
                freezePakId: ''
            }
            let data = []
            console.log('üöÄüöÄüöÄ',node);
            // freezeCom(params,data).then((res)=>{
            //     this.$message.success(res.message)
            // })
        },
        // action‰∫ã‰ª∂
        updateEdit(obj) {
            let params = {
                taskid: this.data.taskId,
                ...obj
            }
            doAction(params).then((res) => {
                this.$message.success(res.message)
            })
        },
    }
};
</script>
<style lang="less" scoped>
.search {
    margin: 10px!important;
}
/deep/ .el-tree{
    height: calc(100% - 110px);
    overflow: auto;
    .tree-select {
        padding: 2.5px 8px 2.5px 0;
    }
    .delect-com-icon {
        width: 15px;
        height: 15px;
    }
    .el-checkbox {
        position: absolute;
        right: 0;
    }
    .el-checkbox__inner {
        background-color: transparent !important;
        border-color: transparent !important;
    }
}

.custom-tree-node {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-right: 8px;
    width: calc(100% - 50px);

    .label-span {
        padding-left: 5px;
        width: calc(100% - 30px);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    .icon,i,img{
        color: #ffffff;
        font-size: 15px;
        margin: 0 2px;
    }
}
</style>
